name: Compilar y lanzar Windows Linux y MacOS

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build project Windows
        run: dotnet publish -c Release --self-contained -r win-x64 -p:PublishReadyToRun=false -p:TieredCompilation=false DungeonSlimeGame/DungeonSlimeGame.csproj -o ./publish/win-x64

      - name: Build project Linux
        run: dotnet publish -c Release --self-contained -r linux-x64 -p:PublishReadyToRun=false -p:TieredCompilation=false DungeonSlimeGame/DungeonSlimeGame.csproj -o ./publish/linux-x64

      - name: Build project MacOS
        run: dotnet publish -c Release --self-contained -r osx-x64 -p:PublishReadyToRun=false -p:TieredCompilation=false DungeonSlimeGame/DungeonSlimeGame.csproj -o ./publish/osx-x64

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-build-files
          path: ./publish

  package:
    needs: build
    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            platform: Windows
          - os: ubuntu-latest
            rid: linux-x64
            platform: Linux
          - os: macos-latest
            rid: osx-x64
            platform: macOS
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: game-build-files
          path: artifacts

      - name: Package files (Windows)
        if: matrix.platform == 'Windows'
        run: Compress-Archive -Path artifacts/${{ matrix.rid }}/* -DestinationPath release-win.zip

      - name: Package files (Linux)
        if: matrix.platform == 'Linux'
        run: |
          chmod +x artifacts/${{ matrix.rid }}
          zip -r release-linux.zip artifacts/${{ matrix.rid }}/*

      - name: Package files (macOS)
        if: matrix.platform == 'macOS'
        run: |
          APP_NAME="DungeonSlime.app"
          EXECUTABLE_NAME="DungeonSlimeGame"
          DMG_NAME="DungeonSlime.dmg"
          VOLUME_NAME="Dungeon Slime"

          mkdir -p "$APP_NAME/Contents/MacOS"
          mkdir -p "$APP_NAME/Contents/Resources"

          cp -a artifacts/osx-x64/* "$APP_NAME/Contents/MacOS/"

          echo '<?xml version="1.0" encoding="UTF-8"?>' > "$APP_NAME/Contents/Info.plist"
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$APP_NAME/Contents/Info.plist"
          echo '<plist version="1.0">' >> "$APP_NAME/Contents/Info.plist"
          echo '<dict>' >> "$APP_NAME/Contents/Info.plist"
          echo '  <key>CFBundleExecutable</key>' >> "$APP_NAME/Contents/Info.plist"
          echo "  <string>$EXECUTABLE_NAME</string>" >> "$APP_NAME/Contents/Info.plist"
          echo '  <key>CFBundleIdentifier</key>' >> "$APP_NAME/Contents/Info.plist"
          echo '  <string>com.leandiez.dungeonslime</string>' >> "$APP_NAME/Contents/Info.plist"
          echo '  <key>CFBundleName</key>' >> "$APP_NAME/Contents/Info.plist"
          echo "  <string>$VOLUME_NAME</string>" >> "$APP_NAME/Contents/Info.plist"
          echo '  <key>CFBundleIconFile</key>' >> "$APP_NAME/Contents/Info.plist"
          echo '  <string>Icon.icns</string>' >> "$APP_NAME/Contents/Info.plist"
          echo '  <key>CFBundlePackageType</key>' >> "$APP_NAME/Contents/Info.plist"
          echo '  <string>APPL</string>' >> "$APP_NAME/Contents/Info.plist"
          echo '</dict>' >> "$APP_NAME/Contents/Info.plist"
          echo '</plist>' >> "$APP_NAME/Contents/Info.plist"

          chmod +x "$APP_NAME/Contents/MacOS/$EXECUTABLE_NAME"

          hdiutil create -fs HFS+ -srcfolder "$APP_NAME" -volname "$VOLUME_NAME" "$DMG_NAME"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.rid }}
          path: |
            *.zip
            *.dmg

  release:
    needs: package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determinar el Tag de la Release
        id: determine_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then

          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")

          MAJOR=$(echo $LATEST_TAG | cut -d '.' -f 1 | tr -d 'v')
          MINOR=$(echo $LATEST_TAG | cut -d '.' -f 2)
          PATCH=$(echo $LATEST_TAG | cut -d '.' -f 3)

          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="v$MAJOR.$MINOR.$NEW_PATCH"

          echo "Último tag encontrado: $LATEST_TAG"
          echo "Nuevo tag calculado: $NEW_TAG"

          echo "release_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "is_manual=true" >> $GITHUB_OUTPUT

          else
          echo "Evento push tag. Usando tag existente."
          echo "release_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "is_manual=false" >> $GITHUB_OUTPUT
          fi

      - name: Crear Nuevo Tag (si es manual)
        if: steps.determine_tag.outputs.is_manual == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          NEW_TAG="${{ steps.determine_tag.outputs.release_tag }}"
          echo "Creando y pusheando nuevo tag: $NEW_TAG"
          git tag $NEW_TAG
          git push origin $NEW_TAG
          
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          pattern: package-*
          merge-multiple: 'true'
          path: packages
      
      - run: ls -R packages

      - name: Release Version
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.determine_tag.outputs.release_tag }}
          draft: false
          prerelease: false
          body: |
            Versión multiplataforma de mi juego MonoGame.
            - Compilado para Windows, Linux y macOS.
          files: packages/*
